{{- /* Initialize variables and configuration */ -}}
{{- $url := .Get "url" -}}
{{- $noFloat := .Get "noFloat" | default false -}}
{{- $defaultImage := "https://rippreport.com/img/placeholder.png" -}}
{{- $workerBaseURL := "https://links.rippreport.com" -}}

{{- return (dict
    "bloximages.chicago2.vip.townnews.com/lagniappemobile.com" (dict
        "pattern" "(resize=)([0-9]+%2C[0-9]+)"
        "replacement" "resize=380%2C200"
    )
    "beta.creativecirclecdn.com/gulfcoast/original" (dict
        "from" "https://beta.creativecirclecdn.com/gulfcoast/original/"
        "to" "https://beta.creativecirclecdn.com/gulfcoast/medium/"
    )
    "www.al.com/resizer/v2" (dict
        "width" "width=380"
        "quality" "quality=75"
    )
) -}}
{{- $sourceConfig := partial "shortcodes/social-preview/source-config" . -}}

{{- /* Fetch link metadata */ -}}
{{- $metadata := dict -}}
{{- with partial "shortcodes/social-preview/fetch-metadata" (dict 
    "url" $url
    "workerBaseURL" $workerBaseURL
    "defaultImage" $defaultImage
) -}}
    {{- $metadata = . -}}
{{- end -}}

{{- /* Render preview component */ -}}
{{- if $metadata.url -}}
    <article class="social-preview{{ if $noFloat }} sink-preview{{ end }}" data-source="{{ $metadata.baseHost }}">
        <a href="{{ $metadata.url | safeURL }}" class="preview-link" rel="noopener noreferrer" aria-label="Read full article: {{ $metadata.title }}">
            <figure class="preview-image">
                <img
                    loading="lazy"
                    src="{{ $metadata.processedImage }}"
                    alt="{{ $metadata.title }}"
                    width="380"
                    height="200"
                    {{- if $metadata.imageSrcset }} srcset="{{ $metadata.imageSrcset }}" sizes="(max-width: 600px) 100vw, 380px"{{ end -}}
                >
            </figure>
            
            <div class="preview-content">
                <header class="preview-header">
                    {{- partial "shortcodes/social-preview/source-logo" (dict 
                        "sourceConfig" $sourceConfig
                        "baseHost" $metadata.baseHost
                        "title" $metadata.title
                    ) -}}
                </header>
                
                {{- with $metadata.description -}}
                    <p class="preview-description">{{ . | truncate 160 }}</p>
                {{- end -}}
                
                <footer class="preview-footer">
                    <span class="read-more">Read More â†’</span>
                    {{- if not (index $sourceConfig $metadata.baseHost) -}}
                        <span class="source-url">{{ $metadata.baseHost }}</span>
                    {{- end -}}
                </footer>
            </div>
        </a>
    </article>
{{- else -}}
    <a href="{{ $url | safeURL }}" class="preview-fallback" rel="noopener noreferrer">{{ $url }}</a>
{{- end -}}