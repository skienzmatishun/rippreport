{{/* Define reusable variables */}}
{{- $url := .Get "url" -}}
{{- $noFloat := .Get "noFloat" | default false -}}
{{- $defaultImage := "https://rippreport.com/img/placeholder.png" -}}
{{- $workerBaseURL := "https://links.rippreport.com" -}}

{{/* Helper function for image URL processing */}}
{{- $processImageURL := dict
    "bloximages.chicago2.vip.townnews.com/lagniappemobile.com" (dict
        "pattern" "(resize=)([0-9]+%2C[0-9]+)"
        "replacement" "resize=380%2C200"
    )
    "beta.creativecirclecdn.com/gulfcoast/original" (dict
        "from" "https://beta.creativecirclecdn.com/gulfcoast/original/"
        "to" "https://beta.creativecirclecdn.com/gulfcoast/medium/"
    )
    "www.al.com/resizer/v2" (dict
        "width" "width=380"
        "quality" "quality=75"
    )
-}}

{{/* First API call */}}
{{- $workerURL := printf "%s?q=%s" $workerBaseURL $url -}}
{{- $json := getJSON $workerURL -}}

{{/* Handle 404 for rippreport.com URLs */}}
{{- if and (isset $json "error") (strings.HasPrefix $json.error "[Error] https://rippreport.com") (strings.Contains $json.error "404") -}}
    {{- $parsedURL := urls.Parse $url -}}
    {{- if eq $parsedURL.Host "rippreport.com" -}}
        {{- $newURL := printf "rippreport.com/p%s" $parsedURL.Path -}}
        {{- $workerURL = printf "%s?q=%s" $workerBaseURL $newURL -}}
        {{- $json = getJSON $workerURL -}}
    {{- end -}}
{{- end -}}

{{/* Process response */}}
{{- if $json.url -}}
    {{- $parsedURL := urls.Parse $url -}}
    {{- $baseURL := $parsedURL.Host -}}
    {{- $image := $json.image | default $defaultImage -}}

    {{/* Use Cloudflare images only for rippreport.com */}}
    {{- if eq $baseURL "rippreport.com" -}}
        {{/* Process image URL based on domain */}}
        {{- range $domain, $rules := $processImageURL -}}
            {{- if strings.HasPrefix $image $domain -}}
                {{- if isset $rules "pattern" -}}
                    {{- $image = $image | replaceRE $rules.pattern $rules.replacement -}}
                {{- else if isset $rules "from" -}}
                    {{- $image = replace $image $rules.from $rules.to -}}
                {{- else if isset $rules "width" -}}
                    {{- $image = $image | replaceRE "width=[0-9]+" $rules.width | replaceRE "quality=[0-9]+" $rules.quality -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

    <div class="social-preview{{ if $noFloat }} sink-preview{{ end }}" data-source="{{ $baseURL }}">
        <a href="{{ $json.url }}" rel="noopener">
            <img
                loading="lazy"
                src="{{ $image }}"
                alt="{{ $json.title }}"
                width="380"
                height="200"
                srcset="
                    /cdn-cgi/image/width=380,quality=75,format=auto{{ $image }} 380w,
                    /cdn-cgi/image/width=250,quality=75,format=auto{{ $image }} 250w,
                    /cdn-cgi/image/width=150,quality=75,format=auto{{ $image }} 150w"
                sizes="(max-width: 380px) 100vw, 380px"
            >
            <h2>
                {{ $json.title }}
            </h2>
            <p>{{ $json.description }}</p>
            <span class="read_more">Read More</span>
        </a>
    </div>
{{- else -}}
    <a href="{{ $url }}" rel="noopener">{{ $url }}</a>
{{- end -}}
