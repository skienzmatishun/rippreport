<script type="text/javascript" src="https://rippreport.com/js/cactus.js"></script>
<div id="comment-section"></div>
<script>
initComments({
  node: document.getElementById("comment-section"),
  defaultHomeserverUrl: "https://matrix.cactus.chat:8448",
  serverName: "cactus.chat",
  siteName: "rippreport.com",
  pageSize: 15,
  commentSectionId: "{{ index .Params 0 }}"
})
// Function to generate color based on username (same as before)
function getColorForUsername(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }

    const primeMultiplier = 37;
    const color = Math.abs((hash * primeMultiplier) % 360); // Get a hue value from 0 to 359
    return `hsl(${color}, 70%, 80%)`; // Light color
}

// Function to apply colors to comments and add Reply button
function applyCommentColors() {
    document.querySelectorAll('.cactus-comment').forEach(comment => {
        const displayNameLink = comment.querySelector('.cactus-comment-displayname');
        const username = displayNameLink.href.split('/').pop(); // Extract username from link

        if (username) {
            // Generate and set the border-left color based on the username
            const borderColor = getColorForUsername(username);
            comment.style.borderLeft = `5px solid ${borderColor}`; // Adjust the width as necessary

            // Add the reply button if it doesn't exist
            if (!comment.querySelector('.reply-button')) {
                const replyButton = document.createElement('button');
                replyButton.classList.add('reply-button');
                replyButton.innerText = 'Reply ðŸ—£';

                // Add event listener for reply button
                replyButton.addEventListener('click', () => {
                    addReplyToTextarea(username, borderColor);
                });

                comment.appendChild(replyButton); // Append the button to the comment
            }
        }
    });
}

// Function to add the reply to the top of the cactus-editor-textarea
function addReplyToTextarea(username, color) {
    const textarea = document.querySelector('.cactus-editor-textarea');

    if (textarea) {
        // Create the reply string with the username highlighted in the border color
        const replyText = `<span style="color:${color}; font-weight: bold;">@${username}</span> `;

        // Insert at the top of the textarea
        textarea.innerHTML = replyText + textarea.innerHTML;
    }
}

// Create a Mutation Observer to watch for changes in the comments container
const commentsContainer = document.querySelector('.cactus-comments-container');

const observer = new MutationObserver(mutations => {
    for (const mutation of mutations) {
        if (mutation.addedNodes.length || mutation.removedNodes.length) {
            // New comments have been added or removed, apply colors and buttons
            applyCommentColors();
        }
    }
});

// Start observing the comments container for child node changes
if (commentsContainer) {
    observer.observe(commentsContainer, { childList: true, subtree: true });
}

// Function to apply colors after initial delay, and then again after another 8000ms
function delayedColorApplication() {
    setTimeout(() => {
        applyCommentColors(); // First application after 8000ms
        setTimeout(applyCommentColors, 5000); // Second application after another 8000ms
    }, 3000);
}

// Start the color application process
delayedColorApplication();

// Create a Mutation Observer for detecting when the button is added to the DOM
const buttonObserver = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
            if (node.classList && node.classList.contains('cactus-button')) {
                // Button found, add the event listener
                node.addEventListener('click', () => {
                    setTimeout(() => {
                        applyCommentColors();
                    }, 2000);
                });
                // Once button is found and listener added, disconnect observer
                buttonObserver.disconnect();
            }
        });
    });
});

// Start observing the document for the addition of the button
buttonObserver.observe(document.body, { childList: true, subtree: true });


</script>
