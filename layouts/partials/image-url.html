{{/*
  Image URL helper that works for both localhost and production
  Usage: {{ partial "image-url.html" (dict "path" "/img/example.jpg" "width" 750 "quality" 85) }}
  Usage: {{ partial "image-url.html" (dict "path" "/img/example.gif" "width" 750 "quality" 85 "bypass_cf" true) }}
*/}}

{{- $path := .path -}}
{{- $width := .width | default 750 -}}
{{- $quality := .quality | default 85 -}}
{{- $format := .format | default "auto" -}}
{{- $blur := .blur | default "" -}}
{{- $onerror := .onerror | default "" -}}
{{- $bypassCF := .bypass_cf | default false -}}

{{- $site := .Site | default site -}}
{{- $isLocalhost := or (strings.Contains $site.BaseURL "localhost") (strings.Contains $site.BaseURL "127.0.0.1") -}}

{{/* Check if this is an animated image (GIF files are always animated) */}}
{{- $isAnimated := strings.HasSuffix $path ".gif" -}}

{{- if or $isLocalhost $isAnimated $bypassCF -}}
  {{/* For localhost, animated images, or explicitly bypassed images, use original images without Cloudflare processing */}}
  {{- if strings.HasPrefix $path "/" -}}
    {{- $path -}}
  {{- else -}}
    {{- printf "/%s" $path -}}
  {{- end -}}
{{- else -}}
  {{/* For production static images, use Cloudflare Images */}}
  {{- $params := slice (printf "width=%d" $width) (printf "quality=%d" $quality) (printf "format=%s" $format) -}}
  {{- if $blur -}}
    {{- $params = $params | append (printf "blur=%s" $blur) -}}
  {{- end -}}
  {{- if $onerror -}}
    {{- $params = $params | append (printf "onerror=%s" $onerror) -}}
  {{- end -}}
  {{- $absolutePath := $path -}}
  {{- if not (strings.HasPrefix $path "/") -}}
    {{- $absolutePath = printf "/%s" $path -}}
  {{- end -}}
  {{- printf "/cdn-cgi/image/%s%s" (delimit $params ",") $absolutePath -}}
{{- end -}}