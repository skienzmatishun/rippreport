{{ $sidebar := .Site.Params.sidebar.default }}

{{ if eq .Kind "home" }}
    {{ $sidebar = default .Site.Params.sidebar.home .Params.sidebar }}
{{ else if eq .Kind "page" }}
    {{ $sidebar = default .Site.Params.sidebar.single .Params.sidebar }}
{{ else }}
    {{ $sidebar = default .Site.Params.sidebar.list .Params.sidebar }}
{{ end }}

{{ if $sidebar }}
<aside class="sidebar{{ if eq $sidebar "left" }} sidebar--left{{ end }}">

    {{ partial "important-events.html" . }}

    {{- $root := . }} {{/* $root is the page context */}}
    {{- with default .Site.Params.sidebar.widgets .Params.widgets }}
        {{- range $widget := . }}
            {{- $p := printf "widgets/%s.html" $widget }}
            {{- partial $p $root }} {{/* Correctly passes page context to widgets from the list */}}
        {{- end }}

        {{/* --- CORRECTED LINE --- */}}
        {{/* Now passing the page context ($root) to related-posts.html */}}
        {{ partial "widgets/related-posts.html" $root }}

    {{- else }}
        {{/* This 'else' block is for when '.Site.Params.sidebar.widgets' AND '.Params.widgets' are both empty. */}}
        {{/* If you want related-posts to show even when no other widgets are defined, */}}
        {{/* you might need to adjust its placement or the logic here. */}}
        {{/* For now, this just fixes the context error for the existing structure. */}}
        <p class="sidebar__warning"><strong>{{ T "sidebar_warning" }}:</strong><br>{{ T "sidebar_recommendation" }}</p>
    {{- end }}

</aside>
{{- end }}