{{/* layouts/partials/inline-critical-css.html */}}
{{ $pageContent := .Content }}
{{ $criticalCSS := resources.Get "css/critical.css" | resources.ToCSS }}
{{ $cssMap := dict }}
{{ $classRegex := `class="([^"]+)"` }}
{{ $matches := findRE $classRegex $pageContent }}

{{ range $matches }}
  {{ $classes := (index . 1) | split " " }}
  {{ range $classes }}
    {{ $cssMap = merge $cssMap (dict . true) }}
  {{ end }}
{{ end }}

{{ $inlineCSS := slice }}
{{ range $cssMap }}
  {{ $inlineCSS = $inlineCSS | append (printf ".%s" .) }}
{{ end }}

{{ $filteredCSS := $criticalCSS.Content | split "\n" }}
{{ $inlinedRules := slice }}

{{ range $filteredCSS }}
  {{ $rule := . | string }}
  {{ $ruleTrimmed := $rule | trim }}
  {{ range $inlineCSS }}
    {{ $class := . | string }}
    {{ if (findRE (printf "^%s" $class) $ruleTrimmed) }}
      {{ $inlinedRules = $inlinedRules | append $ruleTrimmed }}
      {{ break }}
    {{ end }}
  {{ end }}
{{ end }}

<style>
{{ range $inlinedRules }}
  {{ . }}
{{ end }}
</style>
