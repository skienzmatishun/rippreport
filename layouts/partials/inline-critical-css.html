{{/* layouts/partials/inline-critical-css.html */}}
{{ $pageContent := .Content }}
{{ $criticalCSS := resources.Get "css/critical.css" }}

{{ printf "Debug: $criticalCSS = %T" $criticalCSS | safeHTML }}
{{ printf "Debug: $criticalCSS.Content = %s" $criticalCSS.Content | safeHTML }}

{{ $cssMap := dict }}
{{ $classRegex := `class="([^"]+)"` }}
{{ $matches := findRE $classRegex $pageContent }}

{{ printf "Debug: $matches = %v" $matches | safeHTML }}

{{ range $matches }}
  {{ $classes := (index . 1) | split " " }}
  {{ printf "Debug: $classes = %v" $classes | safeHTML }}
  {{ range $classes }}
    {{ printf "Debug: Processing class: %s" . | safeHTML }}
    {{ $cssMap = merge $cssMap (dict . true) }}
  {{ end }}
{{ end }}

{{ printf "Debug: $cssMap = %v" $cssMap | safeHTML }}

{{/*
{{ $inlineCSS := slice }}
{{ range $cssMap }}
  {{ $class := printf ".%s" (string .) }}
  {{ printf "Debug: Appending to inlineCSS: %s" $class | safeHTML }}
  {{ $inlineCSS = $inlineCSS | append $class }}
{{ end }}

{{ printf "Debug: $inlineCSS = %v" $inlineCSS | safeHTML }}

{{ $filteredCSS := split ($criticalCSS.Content | safeCSS) "\n" }}
{{ $inlinedRules := slice }}

{{ range $filteredCSS }}
  {{ $rule := . | string }}
  {{ range $inlineCSS }}
    {{ $class := . | string }}
    {{ printf "Debug: Checking rule: %s against class: %s" $rule $class | safeHTML }}
    {{ if (findRE (printf "^%s" $class) $rule) }}
      {{ $inlinedRules = $inlinedRules | append $rule }}
      {{ printf "Debug: Appending rule to inlinedRules: %s" $rule | safeHTML }}
      {{ break }}
    {{ end }}
  {{ end }}
{{ end }}

{{ printf "Debug: $inlinedRules = %v" $inlinedRules | safeHTML }}
*/}}

<style>
{{/* {{ range $inlinedRules }} */}}
  {{/* {{ . }} */}}
{{/* {{ end }} */}}
</style>
