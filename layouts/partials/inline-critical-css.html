{{/* layouts/partials/inline-critical-css.html */}}
{{ $pageContent := .Content }}
{{ $criticalCSS := resources.Get "css/critical.css" }}
{{ $cssMap := dict }}
{{ $classRegex := `class="([^"]+)"` }}
{{ $matches := findRE $classRegex $pageContent }}

{{ range $matches }}
  {{ $classes := (index . 1) | split " " }}
  {{ range $classes }}
    {{ printf "Processing class: %s" . | safeHTML }}
    {{ $cssMap = merge $cssMap (dict . true) }}
  {{ end }}
{{ end }}

{{ printf "CSS Map: %v" $cssMap | safeHTML }}

{{ $inlineCSS := slice }}
{{ range $cssMap }}
  {{ $class := printf ".%s" (string .) }}
  {{ printf "Appending to inlineCSS: %s" $class | safeHTML }}
  {{ $inlineCSS = $inlineCSS | append $class }}
{{ end }}

{{ printf "Inline CSS: %v" $inlineCSS | safeHTML }}

{{ $filteredCSS := split ($criticalCSS.Content | safeCSS) "\n" }}
{{ $inlinedRules := slice }}

{{ range $filteredCSS }}
  {{ $rule := . | string }}
  {{ range $inlineCSS }}
    {{ $class := . | string }}
    {{ printf "Checking rule: %s against class: %s" $rule $class | safeHTML }}
    {{ if (findRE (printf "^%s" $class) $rule) }}
      {{ $inlinedRules = $inlinedRules | append $rule }}
      {{ printf "Appending rule to inlinedRules: %s" $rule | safeHTML }}
      {{ break }}
    {{ end }}
  {{ end }}
{{ end }}

{{ printf "Inlined Rules: %v" $inlinedRules | safeHTML }}

<style>
{{ range $inlinedRules }}
  {{ . }}
{{ end }}
</style>
