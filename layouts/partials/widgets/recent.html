{{/* Configuration */}}
{{- $config := dict
    "excludedCategories" (slice "holiday")
    "defaultRecentNum" 10
    "thumbnailConfig" (dict
        "width" 431
        "quality" 75
        "format" "auto"
    )
    "specialCategories" (slice
        (dict "name" "dwtd" "class" "dwtd__widget__item")
        (dict "name" "backstory-podcast" "class" "backstory__widget__item")
    )
-}}

{{/* Initialize variables */}}
{{- $recent := where .Site.RegularPages "Type" "in" .Site.Params.mainSections -}}
{{- $currentPost := . -}}
{{- $recent_num := .Site.Params.widgets.recent_num | default $config.defaultRecentNum -}}

{{/* Determine which posts to show based on context */}}
{{- $recentToShow := slice -}}
{{- if .IsHome -}}
    {{- $recentToShow = after 10 $recent -}}
{{- else if .Paginator -}}
    {{- $recentToShow = where $recent "Params.categories" "not in" $config.excludedCategories -}}
{{- else -}}
    {{- $currentCategories := .Params.categories | default slice -}}
    {{- if gt (len $currentCategories) 0 -}}
        {{- $firstCategory := index $currentCategories 0 -}}
        {{- $recentToShow = where $recent "Params.categories" "intersect" (slice $firstCategory) -}}
    {{- else -}}
        {{- $recentToShow = where $recent "Params.categories" "not in" $config.excludedCategories -}}
    {{- end -}}
{{- end -}}

{{/* Filter out current post and excluded categories */}}
{{- $filteredRecent := where $recentToShow "ne" $currentPost | where "Params.categories" "not intersect" $config.excludedCategories -}}

{{- if gt (len $filteredRecent) 0 -}}
<div class="widget-recent widget">
    <h4 class="widget__title">
        {{- if .IsHome -}}
            More Posts
        {{- else -}}
            Related
        {{- end -}}
    </h4>

    <div class="widget__content">
        <ul class="widget__list">
            {{- range first $recent_num $filteredRecent -}}
                {{/* Determine special category classes */}}
                {{- $specialClass := "" -}}
                {{- range $config.specialCategories -}}
                    {{- if in $.Params.categories .name -}}
                        {{- $specialClass = .class -}}
                    {{- end -}}
                {{- end -}}

                <li class="widget__item{{ with $specialClass }} {{ . }}{{ end }}">
                    <article class="post-preview">
                        <a class="widget__link" href="{{ .RelPermalink }}" aria-label="{{ .Title }}">
                            <h3>{{ .Title }}</h3>

                            {{- with .Params.thumbnail -}}
                                <div class="widget__thumbnail" aria-hidden="true">
                                    <img
                                        loading="lazy"
                                        src="/cdn-cgi/image/width={{ $config.thumbnailConfig.width }},quality={{ $config.thumbnailConfig.quality }},format={{ $config.thumbnailConfig.format }}/{{ . }}"
                                        alt="{{ $.Title }} thumbnail"
                                        class="widget__thumbnail-image"
                                        width="{{ $config.thumbnailConfig.width }}"
                                        height="200"
                                    >
                                </div>
                            {{- end -}}

                            <p class="widget__summary">
                                {{- .Summary | truncate 160 -}}
                            </p>
                        </a>
                    </article>
                </li>
            {{- end -}}
        </ul>
    </div>
</div>

{{- end -}}
