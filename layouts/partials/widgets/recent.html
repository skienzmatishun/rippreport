{{- $recent := where .Site.RegularPages "Type" "in" .Site.Params.mainSections }}
{{- $currentPost := . }}
{{- $recent_num := (.Site.Params.widgets.recent_num | default 10) }}
{{- $recentToShow := slice }}

{{- if not .IsHome }}
  {{- if in (or $currentPost.Params.categories (slice)) "holiday" }}
    {{- $recentToShow = where $recent "Params.categories" "holiday" }}
    {{- if $currentPost.Permalink }}
      {{- $recentToShow = where $recentToShow "Permalink" "ne" $currentPost.Permalink }}
    {{- end }}
  {{- else }}
    {{- $recentToShow = where $recent "Params.categories" "not in" (slice "holiday") }}
    {{- if $currentPost.Params.categories }}
      {{- $categories := $currentPost.Params.categories }}
      {{- $filteredRecent := slice }}
      {{- range $recentToShow }}
        {{- if and (ne . $currentPost) (gt (len (intersect .Params.categories $categories)) 0) }}
          {{- $filteredRecent = $filteredRecent | append . }}
        {{- end }}
      {{- end }}
      {{- $recentToShow = $filteredRecent }}
    {{- end }}
  {{- end }}
{{- else }}
  {{- if in (or $currentPost.Params.categories (slice)) "holiday" }}
    {{- $recentToShow = after 10 (where $recent "Params.categories" "holiday") }}
    {{- if $currentPost.Permalink }}
      {{- $recentToShow = where $recentToShow "Permalink" "ne" $currentPost.Permalink }}
    {{- end }}
  {{- else }}
    {{- $recentToShow = after 10 (where $recent "Params.categories" "not in" (slice "holiday")) }}
  {{- end }}
{{- end }}

<!-- Debug Statements -->
<div style=display:none>
  <p>Is Home: {{ .IsHome }}</p>
  <p>Current Post Permalink: {{ $currentPost.Permalink }}</p>
  <p>Current Post Categories: {{ $currentPost.Params.categories }}</p>
  <p>Recent Posts Count: {{ len $recent }}</p>
  <p>Recent Posts to Show: {{ len $recentToShow }}</p>
  <ul>
    {{- range $recentToShow }}
      <li>{{ .Title }} - {{ .RelPermalink }} - Categories: {{ .Params.categories }}</li>
    {{- end }}
  </ul>
</div>

{{- if gt (len $recentToShow) 0 }}
  <div class="widget-recent widget">
    <h4 class="widget__title">{{ if .IsHome }}More Posts{{ else }}{{ T "recent_title" }}{{ end }}</h4>
    <div class="widget__content">
      <ul class="widget__list">
        {{- range first $recent_num $recentToShow }}
          {{- $thumbnailURL := "../../../" }}
          {{- if and .Params.thumbnail (ne .Page nil) (eq (printf "%T" .Page) "*hugolib.page") }}
            {{- $thumbnailURL = "../../" }}
          {{- end }}
          <li class="widget__item {{ if in .Params.categories "dwtd" }}dwtd__widget__item{{ else if in .Params.categories "backstory-podcast" }}backstory__widget__item{{ end }}">
            <a class="widget__link" href="{{ .RelPermalink }}">
              {{ .Title }}
              {{- with .Params.thumbnail }}
                <div style="min-height:200px;" class="widget__thumbnail">
                  <img loading="lazy" src="{{ $thumbnailURL }}{{ . }}" alt="Thumbnail" class="widget__thumbnail-image">
                </div>
              {{- end }}
            </a>
            <p class="widget__summary">{{ .Summary }}</p>
          </li>
        {{- end }}
      </ul>
    </div>
  </div>
{{- end }}
