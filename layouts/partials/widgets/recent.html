{{- $recent := where .Site.RegularPages "Type" "in" .Site.Params.mainSections }}
{{- $currentPost := . }}
{{- $recent_num := (.Site.Params.widgets.recent_num | default 10) }}

{{- $getRecentToShow := func (pages) (slice) }}
  {{- if .IsHome }}
    {{- return (after 10 pages) }}
  {{- else if .Paginator.HasPages }}
    {{- return (where pages "Params.categories" "not in" (slice "holiday")) }}
  {{- else }}
    {{- $currentCategories := .Params.categories | default slice }}
    {{- if gt (len $currentCategories) 0 }}
      {{- $firstCategory := index $currentCategories 0 }}
      {{- return (where pages "Params.categories" "intersect" (slice $firstCategory)) }}
    {{- else }}
      {{- return (where pages "Params.categories" "not in" (slice "holiday")) }}
    {{- end }}
  {{- end }}
{{- end }}

{{- $recentToShow := $getRecentToShow $recent }}
{{- $filteredRecent := slice }}

{{- range $recentToShow }}
  {{- if and (ne . $currentPost) (not (in .Params.categories "holiday")) }}
    {{- $filteredRecent = $filteredRecent | append . }}
  {{- end }}
{{- end }}

{{- if gt (len $filteredRecent) 0 }}
<div class="widget-recent widget">
  <h4 class="widget__title">{{ if .IsHome }}More Posts{{ else }}{{ T "recent_title" }}{{ end }}</h4>
  <div class="widget__content">
    <ul class="widget__list">
      {{- range first $recent_num $filteredRecent }}
        {{- $thumbnailURL := "" }}
        {{- if .Params.thumbnail }}
          {{- $thumbnailURL = .Params.thumbnail }}
        {{- else if and .Page (eq (printf "%T" .Page) "*hugolib.page") }}
          {{- $thumbnailURL = "../../images/default-thumbnail.jpg" }} <!-- Default thumbnail -->
        {{- else }}
          {{- $thumbnailURL = "../../../images/default-thumbnail.jpg" }} <!-- Default thumbnail -->
        {{- end }}
        <li class="widget__item {{ if in .Params.categories "dwtd" }}dwtd__widget__item{{ else if in .Params.categories "backstory-podcast" }}backstory__widget__item{{ end }}">
          <a class="widget__link" href="{{ .RelPermalink }}">
            {{ .Title }}
            {{- with .Params.thumbnail }}
              <div style="min-height:200px;" class="widget__thumbnail">
                <img loading="lazy" src="{{ $thumbnailURL }}" alt="Thumbnail" class="widget__thumbnail-image">
              </div>
            {{- end }}
          </a>
          <p class="widget__summary">{{ .Summary }}</p>
        </li>
      {{- end }}
    </ul>
  </div>
</div>
{{- else }}
<div class="widget-recent widget">
  <h4 class="widget__title">{{ if .IsHome }}More Posts{{ else }}{{ T "recent_title" }}{{ end }}</h4>
  <div class="widget__content">
    <p>No recent posts available.</p>
  </div>
</div>
{{- end }}
