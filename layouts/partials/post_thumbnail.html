{{- $class := .class }}
{{- $page := .page }}
{{- $defaultVisibility := slice "list" "post" }}
{{- $embedRendered := false }} <!-- Variable to control if an embed has already been rendered -->

<!-- Check for YouTube embed -->
{{- if $youtube := $page.Params.youtube }}
  {{- if not $embedRendered }}
    <!-- Render YouTube embed for the first instance -->
    <a class="thumbnail__link" href="{{ $page.RelPermalink }}" aria-label="View {{ $page.Title }}">
      <figure class="thumbnail">
        <div class="thumbnail__video" style="background-image: url('/cdn-cgi/image/width=500,quality=50,blur=5,onerror=redirect,format=auto{{ $page.Params.thumbnail | relURL }}'); background-size: cover; background-position: center; min-height:400px;">
          <div class="video-container">
            <iframe
              loading="lazy"
              class="thumbnail__iframe"
              src="https://www.youtube.com/embed/{{ $youtube }}"
              title="{{ $page.Title }} - YouTube video"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
            {{ partial "svg/loading.svg" (dict "class" "loading") -}}
          </div>
        </div>
      </figure>
    </a>
    {{- $embedRendered = true }}
  {{- else }}
    <!-- Render only thumbnail for subsequent YouTube instances -->
    <a class="thumbnail__link" href="{{ $page.RelPermalink }}" aria-label="View {{ $page.Title }}">
      <figure class="thumbnail">
        <div class="thumbnail__video">
          <img
            class="thumbnail__image"
            srcset="
              /cdn-cgi/image/width=1000,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 1000w,
              /cdn-cgi/image/width=750,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 750w,
              /cdn-cgi/image/width=500,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 500w"
            sizes="(max-width: 500px) 100vw, (max-width: 750px) 50vw, 1000px"
            alt="{{ $page.Title }}"
          >
        </div>
      </figure>
    </a>
  {{- end }}

<!-- Check for Rumble embed if YouTube is not found -->
{{- else if $rumble := $page.Params.rumble }}
  {{- if not $embedRendered }}
    <!-- Render Rumble embed for the first instance -->
    <figure class="thumbnail">
      <div class="thumbnail__video" style="background-image: url('/cdn-cgi/image/width=500,quality=50,blur=5,onerror=redirect,format=auto{{ $page.Params.thumbnail | relURL }}'); background-size: cover; background-position: center; min-height:400px;">
        <div
          id="rumble_{{ $rumble }}"
          class="video-container"
          data-rumble-id="{{ $rumble }}"
        >
          <script>
            (function(r,u,m,b,l,e){
              r._Rumble=b;
              if(!r[b]){
                r[b]=function(){
                  (r[b]._=r[b]._||[]).push(arguments);
                  if(r[b]._.length==1){
                    l=u.createElement(m);
                    e=u.getElementsByTagName(m)[0];
                    l.async=1;
                    l.src="https://rumble.com/embedJS/u4"+(arguments[1].video?'.'+arguments[1].video:'')+"/?url="+encodeURIComponent(location.href)+"&args="+encodeURIComponent(JSON.stringify([].slice.apply(arguments)));
                    e.parentNode.insertBefore(l,e);
                  }
                }
              }
            })(window, document, "script", "Rumble");
            Rumble("play", {"video":"{{ $rumble }}","div":"rumble_{{ $rumble }}"});
          </script>
        </div>
        {{ partial "svg/loading.svg" (dict "class" "loading") -}}
      </div>
    </figure>
    {{- $embedRendered = true }}
  {{- else }}
    <!-- Render only thumbnail for subsequent Rumble instances -->
    <a class="thumbnail__link" href="{{ $page.RelPermalink }}" aria-label="View {{ $page.Title }}">
      <figure class="thumbnail">
        <div class="thumbnail__video">
          <img
            class="thumbnail__image"
            srcset="
              /cdn-cgi/image/width=1000,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 1000w,
              /cdn-cgi/image/width=750,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 750w,
              /cdn-cgi/image/width=500,quality=75,format=auto{{ $page.Params.thumbnail | relURL }} 500w"
            sizes="(max-width: 500px) 100vw, (max-width: 750px) 50vw, 1000px"
            alt="{{ $page.Title }}"
          >
        </div>
      </figure>
    </a>
  {{- end }}

<!-- Fallback when no YouTube or Rumble embed is found -->
{{- else }}
  {{- if $thumbnail := $page.Params.thumbnail }}
    {{- $visibility := $page.Site.Params.thumbnail.visibility | default $defaultVisibility }}
    {{- $valueType := printf "%T" $thumbnail -}}
    {{- $isMap := in $valueType "map" -}}

    {{- if $isMap }}
      {{- $visibility = default $defaultVisibility (default $page.Site.Params.thumbnail.visibility $thumbnail.visibility) }}
      {{- $thumbnail = $thumbnail.src }}
    {{- end }}

    {{- if in $visibility $class }}
      <a class="thumbnail__link" href="{{ $page.RelPermalink }}" aria-label="View {{ $page.Title }}">
        <figure class="thumbnail">
          {{- if $thumbnail }}
            <div class="thumbnail__video">
              <img
                class="thumbnail__image"
                srcset="
                  /cdn-cgi/image/width=1000,quality=75,format=auto{{ $thumbnail | relURL }} 1000w,
                  /cdn-cgi/image/width=750,quality=75,format=auto{{ $thumbnail | relURL }} 750w,
                  /cdn-cgi/image/width=500,quality=75,format=auto{{ $thumbnail | relURL }} 500w"
                sizes="(max-width: 500px) 100vw, (max-width: 750px) 50vw, 1000px"
                alt="{{ $page.Title }}"
              >
            </div>
          {{- end }}
        </figure>
      </a>
    {{- end }}
  {{- end }}
{{- end }}
